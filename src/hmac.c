#include <assert.h>
#include <stdlib.h>
#include <string.h>

#include "hmac.h"
#include "bytes.h"

static const byte ipad[] = {
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36
};

/* ipad ^ opad */
static const byte iopad[] = {
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a,
  0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a, 0x6a
};

void hmac_init(hmac_ctx *ctx, const hash_desc *desc,
               const byte *key, uint keylen)
{
  byte k[HASH_MAX_BLOCKLEN];

  assert(sizeof ipad >= desc->blocklen);
  assert(sizeof iopad >= desc->blocklen);

  ctx->hash_desc = desc;
  desc->init(&ctx->ictx);
  desc->init(&ctx->octx);

  if (keylen > desc->blocklen) {
    desc->digest(key, keylen, k);
    memset(k + desc->hashlen, 0, desc->blocklen - desc->hashlen);
  } else {
    memcpy(k, key, keylen);
    memset(k + keylen, 0, desc->blocklen - keylen);
  }

  bytes_xor(k, k, ipad, desc->blocklen);
  desc->update(&ctx->ictx, k, desc->blocklen);

  bytes_xor(k, k, iopad, desc->blocklen);
  desc->update(&ctx->octx, k, desc->blocklen);

  ctx->tmpctx = ctx->ictx;
}

hmac_ctx *hmac_new(const hash_desc *desc, const byte *key, uint keylen)
{
  hmac_ctx *ctx;
  ctx = malloc(sizeof *ctx);
  hmac_init(ctx, desc, key, keylen);
  return ctx;
}

void hmac_reset(hmac_ctx *ctx)
{
  ctx->tmpctx = ctx->ictx;
}

void hmac_update(hmac_ctx *ctx, const byte *m, uint mlen)
{
  ctx->hash_desc->update(&ctx->tmpctx, m, mlen);
}

void hmac_final(hmac_ctx *ctx, byte *h)
{
  ctx->hash_desc->final(&ctx->tmpctx, h);
  ctx->tmpctx = ctx->octx;
  ctx->hash_desc->update(&ctx->tmpctx, h, ctx->hash_desc->hashlen);
  ctx->hash_desc->final(&ctx->tmpctx, h);
}

void hmac_digest(const hash_desc *desc, const byte *key, uint keylen,
                 const byte *m, uint mlen, byte *h)
{
  hmac_ctx ctx;
  hmac_init(&ctx, desc, key, keylen);
  hmac_update(&ctx, m, mlen);
  hmac_final(&ctx, h);
}
